#!/bin/sh

vlaniflist=$1

# Disable ip forwarding on the LAN side vlans since they should
# not be allowed to route between them (see bug #19978)
wanifname=`uci -q get network.wan.ifname`
for vlanif in /proc/sys/net/ipv4/conf/"$wanifname".*; do
    if [ ! -e "$vlanif" ]; then
	continue
    fi
    vlanif=`basename $vlanif`
    val=1
    for vif in $vlaniflist; do
	[ "$vif" = "$vlanif" ] && {
	    # Disable forwarding on lan-side vlans
	    val=0
	    break
	}
    done
    ( cd /proc/sys/net/ipv4/conf/"$vlanif" &&
	echo $val > forwarding )
    #About IPv6! SLAAC wont work if forwarding is enabled on 
    #a interface. To be able to run SLAAC on a routed interface 
    #forwarding must be disabled! Enable forwarding by keep the 
    #"all" and "default" flag enabled:
    # /proc/sys/net/ipv6/conf/all/forwarding=1
    #/proc/sys/net/ipv6/conf/default/forwarding=1
    #In later kernels > 2.6.37 accept_ra can be set to 2 and override
    #default behaviour. Until then add this kludge!
    val=0
    ( cd /proc/sys/net/ipv6/conf/"$vlanif" &&
	echo $val > forwarding )
done
